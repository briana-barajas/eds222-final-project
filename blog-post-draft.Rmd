---
title: "Exploratory Analysis"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r, echo=FALSE}
# data processing
library(tidyverse)
library(here)
library(janitor)
library(lubridate)

# plotting/aesthetics
library(gridExtra)
library(gt)

# time series packages
library(feasts)
library(tsibble)
```

```{r, echo=FALSE}
# import goose data
goose_2006_2016 <- read_csv('data/goose_parasites_2006_2016/emperorGoose_bloodParasites_YKD_buchheit_2006_2016.csv')

# import climate data
precip_raw <- read_csv('data/acrc_climate_data/acrc_annual_precip.csv', skip = 5)
temp_raw <- read_csv('data/acrc_climate_data/acrc_annual_temp.csv', skip = 5)
```

## Data Cleaning

### Tidying Climate Data

In order to explore temperature and precipitation changes over time, I kept a dataset that had more year data then what was needed for the study (1998-2016).

```{r}
# clean names
  # rename(new_name = old_name)
precip_raw <- precip_raw %>% clean_names() %>% 
  rename(annual_precip_in = annual_total_precipitation_in)

temp_raw <- temp_raw %>% clean_names() %>% 
  rename(max_annual_temp = annual_maximum_temperature_deg_f,
         min_annual_temp = annual_minimum_temperature_deg_f,
         max_temp_date = annual_maximum_temperature_date,
         min_temp_date = annual_minimum_temperature_date,
         avg_annual_temp = annual_average_temperature_deg_f)

# join data by year column
clim_data_full <- inner_join(precip_raw, temp_raw) %>% 
  mutate(date = ymd(paste0(year, '01', '01')))

# tidy joined data
clim_data <- clim_data_full %>% 
  mutate(year = as.numeric(clim_data_full$year)) %>% 
  filter(year>=2006 & year <= 2016)
```

### Goose Data

I am primarily interested in prevalence of infection, so I am removing the additional gene bank columns. I also want to create two new parasite columns. One will indicate n/9, where n is the number of parasites (out of 9) that were present in the sample. We'll refer to this as parasite load. Additionally, I want to use these numeric values to create a true/false column indicating parasite presence. The data spans from 2006 to 2016.

```{r}
# clean all names
goose_2006_2016 <- goose_2006_2016 %>% clean_names() %>% 
  select(-contains('bank')) %>% 
  mutate(total_parasite = rowSums(goose_2006_2016[ , c(8,16)], na.rm = TRUE))
```

```{r}
goose_2006_2016 <- goose_2006_2016 %>% 
  clean_names() %>% #clean names
  select(-contains('bank')) %>% #remove gene data cols
  mutate(total_parasite = rowSums(goose_2006_2016[ , c(8,16)],na.rm = TRUE),
         infection = cut(goose_2006_2016$total_parasite,
                      breaks = c(-1,0,2),
                      labels = c('FALSE', 'TRUE')), # t/f infection column
         date = ymd(paste0(year, '01', '01'))) #date-time object

```

### Joining Data

I created a `date` column using January 1st as the day for all years in order for lubridate to recognize the column as a date-time object instead of a number. Therefore, all the data can be joined by `date`

```{r}
goose_clim_full <- left_join(goose_2006_2016, clim_data, by = c('date', 'year'))
```

## Data Exploration

I wanted to do some data exploration before I completely decided what join and statistical testing would be best.

1.  Bar charts for variables of interest

    ```{r}
    # plot annual parasites found
    parasite_bar <- ggplot(goose_2006_2016, aes(x=date,
                     y=total_parasite)) +
      geom_col(fill='indianred3') +
      labs(y='Total Parasites Detected',
           x='Year') +
      theme_minimal()

    # plot annual precipitation
    precip_bar <- ggplot(clim_data, aes(x=date, y=annual_precip_in)) +
      geom_col(fill='lightskyblue2') +
      theme_minimal() +
      theme(plot.title = element_text(hjust = 0.5)) +
      labs(x= 'Year',
           y = 'Annual Precipitation (in)')

    # plot annual average temperature
    temp_bar <- ggplot(clim_data, aes(x=date, y=avg_annual_temp)) +
      geom_col(fill='palegreen3') +
      theme_minimal() +
      labs(x='Year',
           y='Average Annual Temperature (F)')

    grid.arrange(parasite_bar, precip_bar, temp_bar, ncol = 2)
    ```

2.  View how climate has changed over time, linearly. I kept a full data frame from 1923-2022 as well as one with the years specific to the parasite study. I am hoping that the larger sample size from the full climate data will demonstrate changes over time, even if the 10-year span of the study does not

    a\. Summarise data over all years, and years of interest

    ```{r}
    # summary table of full climate data
    clim_data_full %>% 
      summarise(mean_precip = mean(annual_precip_in, na.rm = TRUE),
                sd_precip = sd(annual_precip_in, na.rm = TRUE),
                mean_annual_temp = mean(avg_annual_temp, na.rm = TRUE),
                sd_annual_temp = sd(avg_annual_temp, na.rm = TRUE)) %>% 
      gt() %>% tab_header('Climate Data Summary 1923-2022')

    # summary of study climate data
    clim_data %>% 
      summarise(mean_precip = mean(annual_precip_in, na.rm = TRUE),
                sd_precip = sd(annual_precip_in, na.rm = TRUE),
                mean_annual_temp = mean(avg_annual_temp, na.rm = TRUE),
                sd_annual_temp = sd(avg_annual_temp, na.rm = TRUE)) %>% 
      gt() %>% tab_header('Climate Data Summary 2006-2016')

    ```

    b\. Use full climate data to see how climate variables have changed over time

    ```{r, warning=FALSE, message=FALSE}
    # plot precipitation over time
    precip_scatter <- ggplot(clim_data_full, aes(x=date, y=annual_precip_in)) +
      geom_point() +
      geom_smooth() +
      labs(x='', y='Avg Precipitation (in)') +
      theme_minimal()

    # plot average annual temp over time
    temp_scatter <- ggplot(clim_data_full, aes(x=date, y=avg_annual_temp)) +
      geom_point()+
      geom_smooth() +
        labs(x='Year', y='Avg Annual Temp (F)') +
      theme_minimal()

    grid.arrange(precip_scatter, temp_scatter, ncol=1)
    ```

3.  Time series of infection over time - running into errors with `tsibble()` object type. For the homework, we used a `tsibble()` object before running the decomposition. I am able to coerce the `df` to a populated `tbl_df`, but when I run the decomposition it returns a blank item.

    ```{r}
    # # decomp rain
    # a <- tsibble::as_tsibble(clim_data_full, index='date')
    # 
    # test_decomp <- a %>% 
    #   model(STL(annual_precip_in))
    # 
    # # plot rain decomp
    # components(test_decomp) %>% 
    #   autoplot()

    ```

    ```{r}
    # # create summary table w/annual parasites found
    # parasite_sum <- goose_clim_full %>% 
    #   group_by(year) %>% 
    #   summarise(sum = sum(total_parasite)) %>% 
    #   mutate(date = ymd(paste0(year, '01', '01'))) %>% 
    #   as_tsibble()

    # # decompose trends, seasons, and remainder
    # parasite_decomp <- parasite_sum %>% 
    #   model(STL(sum))
    # 
    # # plot the components
    # parasite_decomp %>%  autoplot()
    ```
