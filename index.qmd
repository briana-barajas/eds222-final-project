---
title: 'Drought Tolerance in Tropical Tree Species'
author: 'Briana Barajas'
date: 'Dec 10, 2023'
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r, include=FALSE}
## ========== Load Libraries ==========
# data processing
library(tidyverse)
library(here)
library(janitor)
library(lubridate)

# plotting/aesthetics
library(sjPlot)

# time series packages
library(feasts)
library(tsibble)
library(dynlm)
library(zoo)
```

```{r, include=FALSE}
## ========== Read in Data ==========
# tree data on diameter breast height
dbh_raw <- read_csv(here('data/long.data.DBH.csv'))

# hourly climate data
clim_1999_2014 <- read_csv(here("data/NADPTowerHourlyData1999_2014.csv")) %>% clean_names()
clim_2015_2023 <- read_csv(here('data/NADPTowerHourlyData2015_2023v2.csv')) %>% clean_names()
```

```{r, include=FALSE}
## ========== Tidy Tree Data =======
# list most sampled species
species_list <- c('DACEXC', 'MANBID', 'CASARB', 'INGLAU')

# data tidy, filter to select species and year
dbh <- dbh_raw %>% 
  mutate(date = as.Date(paste(year, doy, sep="-"),"%Y-%j")) %>% 
  rename(dbh_mm = dbh) %>% 
  filter(species %in% species_list) %>% 
  select(-c('doy', 'year','flag')) %>% 
  group_by(date, species) %>% 
  summarise(mean_daily_dbh = mean(dbh_mm, na.rm = TRUE)) %>% ungroup() %>% 
  filter(date(date) >= "2014-06-01" &
           date(date) < "2016-08-01") %>% 
  mutate(year_mo = yearmonth(date))

# add family and distribution data
dbh <- dbh %>% 
  mutate(family = case_when(species == 'CASARB' ~ 'Salicaceae',
                            species == 'MANBID' ~ 'Sapotaceae',
                            species == 'DACEXC' ~ 'Burseraceae',
                            species == 'INGLAU' ~ 'Fabaceae'),
         distribution = case_when(family == 'Salicaceae' ~ 'wide',
                                  family == 'Sapotaceae' ~ 'narrow',
                                  family == 'Burseraceae' ~ 'narrow',
                                  family == 'Fabaceae' ~ 'wide'),
         distribution = as.factor(distribution))
```

```{r, include=FALSE}
## ========== Tidy Climate Data =====
# clean and filter data from 1999-2014
clim_1999_2014 <- clim_1999_2014 %>% 
  mutate(datetime = mdy_hm(datetime)) %>% 
  filter(date(datetime) >= "2014-06-01" &
           date(datetime) != "2015-01-01") %>% 
  select(c('datetime', 'rain_mm', 'temp_air_degrees_c', 'ppfd_millimoles_m2_hour')) %>% 
  rename('temp_c' = 'temp_air_degrees_c', 
         'ppfd_mmol_m2_hour' = 'ppfd_millimoles_m2_hour')

# clean and filter data from 2015-2023
clim_2015_2023 <- clim_2015_2023 %>% 
  mutate(datetime = ymd_hms(datetime)) %>% 
  filter(date(datetime) < "2016-08-01") %>% 
  select(c('datetime', 'rain_mm_tot', 'air_tc_avg', 'par_tot')) %>% 
  rename('rain_mm' = 'rain_mm_tot',
         'temp_c' = 'air_tc_avg',
         'ppfd_mmol_m2_hour' = 'par_tot')

# bind to combine study time (June 2014 - July 2016)
hourly_conditions <- rbind(clim_1999_2014, clim_2015_2023) %>% 
  mutate(year_mo = yearmonth(datetime))

```

```{r}
## ======== Convert Hourly Data to lower Res =====
# convert hourly climate to daily averages
daily_conditions <- hourly_conditions %>% 
  group_by(date = date(datetime)) %>% 
  summarise(tot_rain_mm = sum(rain_mm, na.rm = TRUE),
            avg_temp_c = mean(temp_c, na.rm = TRUE),
            avg_ppfd_mmol_m2 = mean(ppfd_mmol_m2_hour, na.rm = TRUE)) %>% 
   mutate(year_mo = yearmonth(date))

# create monthly conditions
monthly_conditions <- hourly_conditions %>% 
  group_by(year_mo) %>% 
  summarise(tot_rain_mm = sum(rain_mm, na.rm = TRUE),
            avg_temp_c = mean(temp_c, na.rm = TRUE),
            avg_ppfd_mmol_m2 = mean(ppfd_mmol_m2_hour, na.rm = TRUE))

# replace zeros w/NA, no data collected October 2014
monthly_conditions['tot_rain_mm'][monthly_conditions['tot_rain_mm'] == 0] <- NA

# replace NAs with the mean of previous and next month
monthly_conditions$tot_rain_mm <- na.approx(monthly_conditions$tot_rain_mm)

# remove raw data variables
rm(clim_1999_2014, clim_2015_2023, dbh_raw, hourly_conditions)

```

```{r}
# create fully joined df
clim_dbh_full <- left_join(dbh, daily_conditions, by = c('date','year_mo'))
```



## Motivation

Enter background here...

\[add map\]

When seasonality is removed via decomposition, trends in rainfall and temperature demonstrate signs of drought. 
::: panel-tabset

#### Rainfall Decomposition

```{r}
# decompose monthly rain variable
rain_dcmp <- monthly_conditions %>% 
  as_tsibble(index = year_mo) %>%
  model(STL(tot_rain_mm))

# plot 
components(rain_dcmp) %>% autoplot()
```

#### Temperature Decomposition
```{r}
# decompose monthly average temperature
temp_dcmp <- monthly_conditions %>% 
  as_tsibble(index = year_mo) %>% 
  model(STL(avg_temp_c))

# plot components
components(temp_dcmp) %>% autoplot()
```

:::

## Data

About the data & Luquillo research forest

```{r}
ggplot(data = dbh, aes(x=date, y= mean_daily_dbh, col = distribution)) +
  geom_point() +
  scale_color_manual(values = c('#B40052', '#37947D'))+
  labs(x = "Date",
       y = "Diameter at Breast Height (mm)",
       title = "Mean Diameter of Species") +
  guides(color = guide_legend(title = "Distribution")) +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~species)
```

## Analysis - Static Time Series

### Simple linear regression

A simple linear regression time series looking at tree diameter over time for four species.
```{r}
# create subsets for each individual species
dacexc <- clim_dbh_full %>% filter(species == 'DACEXC') %>% 
  as_tsibble(index = date)
manbid <- clim_dbh_full %>% filter(species == 'MANBID') %>% 
  as_tsibble(index = date)
inglau <- clim_dbh_full %>% filter(species == 'INGLAU') %>% 
  as_tsibble(index = date)
casarb <- clim_dbh_full %>% filter(species == 'CASARB') %>% 
  as_tsibble(index = date)

# run linear regressions
dacexc_model <- lm(mean_daily_dbh ~ date, data = dacexc)
manbid_model <- lm(mean_daily_dbh ~ date, data = manbid)
inglau_model <- lm(mean_daily_dbh ~ date, data = inglau)
casarb_model <- lm(mean_daily_dbh ~ date, data = casarb)

# view results (wide distribution)
tab_model(inglau_model, casarb_model,
          title = 'Wide Distribution',
          dv.labels = c('I. laurina', 'C. arborea'),
          digits = 4)

# view results (narrow distribution)
tab_model(dacexc_model, manbid_model,
          title = "Narrow Distribution",
          dv.labels = c('D. excelsa', 'M. bidentata'),
          digits = 4)
```


### Multiple Linear Regression

Regression using diameter over time, and all climate variables to see if they improve models predictive capability.
```{r}
# run models w/climate variables
dacexc_model2 <- lm(mean_daily_dbh ~ date + tot_rain_mm + 
                      avg_temp_c + avg_ppfd_mmol_m2, data = dacexc)
manbid_model2 <- lm(mean_daily_dbh ~ date + tot_rain_mm + 
                      avg_temp_c + avg_ppfd_mmol_m2, data = manbid)

inglau_model2 <- lm(mean_daily_dbh ~ date + tot_rain_mm + 
                      avg_temp_c + avg_ppfd_mmol_m2, data = inglau)
casarb_model2 <- lm(mean_daily_dbh ~ date + tot_rain_mm + 
                      avg_temp_c + avg_ppfd_mmol_m2, data = casarb)

# view results (wide distribution)
tab_model(inglau_model2, casarb_model2,
          title = 'Wide Distribution',
          dv.labels = c('I. laurina', 'C. arborea'),
          digits = 4)

# view results (narrow distribution)
tab_model(dacexc_model2, manbid_model2,
          title = "Narrow Distribution",
          dv.labels = c('D. excelsa', 'M. bidentata'),
          digits = 4)
```

## Analysis - Dynamic Time Series
Introducing lag into tree growth
```{r, eval=FALSE}
# conduct dynamic regression
dacexc_model3 <- dynlm(mean_daily_dbh ~ lag(tot_rain_mm, 1) + lag(avg_temp_c, 1) +
                         lag(avg_ppfd_mmol_m2, 1), data = dacexc)
manbid_model3 <- dynlm(mean_daily_dbh ~ lag(tot_rain_mm, 1) + lag(avg_temp_c, 1) +
                         lag(avg_ppfd_mmol_m2, 1), data = manbid)
inglau_model3 <- dynlm(mean_daily_dbh ~ lag(tot_rain_mm, 1) + lag(avg_temp_c, 1) +
                         lag(avg_ppfd_mmol_m2, 1), data = inglau)
casarb_model3 <- dynlm(mean_daily_dbh ~ lag(tot_rain_mm, 1) + lag(avg_temp_c, 1) +
                         lag(avg_ppfd_mmol_m2, 1), data = casarb)

# view results (wide distribution)
tab_model(inglau_model3, casarb_model3,
          title = 'Wide Distribution',
          dv.labels = c('I. laurina', 'C. arborea'),
          digits = 4)

# view results (narrow distribution)
tab_model(dacexc_model3, manbid_model3,
          title = "Narrow Distribution",
          dv.labels = c('D. excelsa', 'M. bidentata'),
          digits = 4)
```




## Results

Add plots with short descriptions

## Limitations

Data limitations, time, missing values, etc.
